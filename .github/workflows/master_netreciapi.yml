name: Build, Test, Publish, Deploy


on:
push:
branches: [ "main" ]
workflow_dispatch:


env:
DOTNET_VERSION: "8.0.x"
API_PROJECT: "src/CulinaryRecipes.API/CulinaryRecipes.API.csproj"
SOLUTION: "CulinaryRecipes.sln"
PUBLISH_DIR: "./publish"
AZURE_WEBAPP_NAME: "YOUR_APP_SERVICE_NAME" # <- change


jobs:
ci:
name: Build & Test & Publish
runs-on: ubuntu-latest


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Setup .NET
uses: actions/setup-dotnet@v4
with:
dotnet-version: ${{ env.DOTNET_VERSION }}


- name: Restore
run: dotnet restore ${{ env.SOLUTION }}


- name: Build
run: dotnet build ${{ env.SOLUTION }} -c Release --no-restore


# ✅ If tests fail, the job fails and the pipeline is NOT successful
- name: Test
run: dotnet test ${{ env.SOLUTION }} -c Release --no-build --verbosity normal


# ✅ Publish ONLY the API project (prevents deploying *.Tests.runtimeconfig.json)
- name: Publish API
run: dotnet publish ${{ env.API_PROJECT }} -c Release -o ${{ env.PUBLISH_DIR }} --no-build


- name: Upload artifact (published app)
uses: actions/upload-artifact@v4
with:
name: api_publish
path: ${{ env.PUBLISH_DIR }}


deploy:
name: Deploy to Azure App Service
runs-on: ubuntu-latest
needs: ci # ✅ deploy runs ONLY if ci (including tests) succeeded


steps:
- name: Download artifact
uses: actions/download-artifact@v4
with:
name: api_publish
path: ${{ env.PUBLISH_DIR }}


- name: Deploy
uses: azure/webapps-deploy@v3
with:
app-name: ${{ env.AZURE_WEBAPP_NAME }}
publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
package: ${{ env.PUBLISH_DIR }}